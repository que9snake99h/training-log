<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Workout Log</title>
  <style>
    :root{
      --gap:8px; --radius:14px;
      --font-lg:22px; --font-md:18px; --font-sm:15px; --font-xs:14px;
      --cell-h:35px; --cell-h-train:50px;
      --bg:#0f172a; --panel:#020617; --cell:#111827;
      --accent:#22c55e;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,"Noto Sans JP",sans-serif;background:var(--bg);color:#e5e7eb;height:100vh;overflow:hidden}
    .app{display:flex;flex-direction:column;height:100%;padding:10px;gap:10px}

    header{display:flex;justify-content:space-between;align-items:center}
    header input{font-size:var(--font-lg);background:var(--panel);color:#e5e7eb;border:none;border-radius:10px;padding:6px 10px}
    .menu-btn{font-size:var(--font-md);padding:10px 14px;border-radius:12px;border:none;background:#1e293b;color:#e5e7eb}

    .weight-wrap{display:grid;grid-template-columns:65% 35%;gap:8px;align-items:center}
    .weight-stats{background:var(--panel);border-radius:var(--radius);padding:10px;font-size:20px;display:flex;flex-direction:column;justify-content:center;gap:6px}
    .weight-stats div { display: flex; justify-content: space-between; }
    .weight-stats .action-buttons{margin-top:8px}
    .weight-main{background:var(--panel);border-radius:var(--radius);padding:6px;font-size:18px;font-weight:800;text-align:center;display:flex;align-items:center;gap:4px;justify-content:center;height:100%}
    .weight-main input{font-size:24px;width:80px;text-align:center;background:transparent;color:white;border:1px solid #334155;border-radius:8px;outline:none}
    .weight-unit{font-size:18px}

    section{background:var(--panel);border-radius:var(--radius);padding:10px;flex:1;overflow-y:auto}
    section h2{margin:0 0 6px;font-size:var(--font-md)}

    .grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:var(--gap)}
    .item{height:36px;background:var(--cell);border-radius:12px;display:flex;align-items:center;padding:0 10px;font-size:var(--font-sm);cursor:pointer}
    .item label{display:flex;align-items:center;gap:8px;width:100%;cursor:pointer}
    .item input[type=checkbox]{width:18px;height:18px}
    .count{margin-left:auto;font-weight:700;color:#94a3b8}

    .train .item{height:48px}

    .action-buttons{display:flex;gap:10px}
    .action-buttons button{flex:1;height:40px;font-size:var(--font-md);font-weight:700;border-radius:14px;border:none;cursor:pointer}
    .save{background:var(--accent);color:#052e16}
    .history{background:#1e293b;color:#e5e7eb}

    /* modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;z-index:100}
    .modal.show{display:flex;align-items:end}
    .sheet{background:var(--panel);border-radius:20px 20px 0 0;padding:20px;width:100%;max-height:85%;overflow-y:auto}
    .sheet h3{margin:0 0 15px}
    .edit-row{display:flex;gap:6px;margin-bottom:8px}
    .edit-row input{flex:1;font-size:16px;padding:8px;background:#1e293b;border:none;color:white;border-radius:8px}
    .edit-row button{padding:0 15px;background:#ef4444;color:white;border:none;border-radius:8px}
    .close-btn{width:100%;margin-top:15px;padding:12px;background:#334155;color:white;border:none;border-radius:12px}

    /* toast */
    #toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:var(--accent);color:#052e16;padding:10px 20px;border-radius:20px;font-weight:bold;display:none;z-index:1000}
  </style>
</head>
<body>
<div class="app">
  <header>
    <input type="date" id="dateInput" onchange="loadDayData()" />
    <button class="menu-btn" onclick="openEdit()">メニュー編集</button>
  </header>

  <div class="weight-wrap">
    <div class="weight-stats">
      <div><span>前日:</span> <span><span id="yWeightDisplay">-</span> kg</span></div>
      <div><span>7日平均:</span> <span><span id="avgWeightDisplay">-</span> kg</span></div>
      <div class="action-buttons">
        <button class="save" onclick="save()">保存</button>
        <button class="history" onclick="showHistory()">履歴</button>
      </div>
    </div>
    <div class="weight-main">
      <input type="number" step="0.1" id="weightInput" value="" inputmode="decimal" oninput="updateWeightStats()" />
      <span class="weight-unit">kg</span>
    </div>
  </div>

  <section class="train">
    <h2>トレーニング</h2>
    <div class="grid2" id="trainList"></div>
  </section>

  <section>
    <h2>ストレッチ</h2>
    <div class="grid2" id="stretchList"></div>
  </section>
</div>

<div id="toast">保存しました</div>

<!-- 履歴一覧 -->
<div class="modal" id="historyModal">
  <div class="sheet">
    <h3>履歴一覧</h3>
    <div id="historyList"></div>
    <button class="close-btn" onclick="closeHistory()">閉じる</button>
  </div>
</div>

<!-- メニュー編集 -->
<div class="modal" id="editModal">
  <div class="sheet">
    <h3>トレーニング</h3>
    <div id="editTrainList"></div>
    <button onclick="addTrainItem()" style="width:100%;padding:8px;margin-bottom:15px">＋追加</button>

    <h3>ストレッチ</h3>
    <div id="editStretchList"></div>
    <button onclick="addStretchItem()" style="width:100%;padding:8px">＋追加</button>

    <button class="close-btn" onclick="closeEdit()">完了</button>
  </div>
</div>

<script>
// --- 初期データ ---
const defaultTrain = [{name:'腕立て',count:'20'},{name:'スクワット',count:'20'}];
const defaultStretch = ['頭','首','肩','背中','腰','足'];

let trainMenu = JSON.parse(localStorage.getItem('trainMenu')) || defaultTrain;
let stretchMenu = JSON.parse(localStorage.getItem('stretchMenu')) || defaultStretch;

const dateEl = document.getElementById('dateInput');
const weightEl = document.getElementById('weightInput');

// ローカルの日付文字列 (YYYY-MM-DD) を取得するヘルパー
function getLocalDateString(date) {
  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2, '0');
  const d = String(date.getDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
}

// 初期化: 今日をセット
dateEl.value = getLocalDateString(new Date());

// --- 表示更新 ---
function renderLists() {
  const trainList = document.getElementById('trainList');
  const stretchList = document.getElementById('stretchList');
  
  trainList.innerHTML = trainMenu.map((t, i) =>
    `<div class="item"><label><input type="checkbox" data-t="${i}"> ${t.name}</label><span class="count">${t.count}</span></div>`).join('');
  stretchList.innerHTML = stretchMenu.map((s, i) =>
    `<div class="item"><label><input type="checkbox" data-s="${i}"> ${s}</label></div>`).join('');
}

// --- データ読み込み ---
function loadDayData() {
  const key = 'log-' + dateEl.value;
  const log = JSON.parse(localStorage.getItem(key));
  
  if (log) {
    weightEl.value = log.weight || "";
    document.querySelectorAll('[data-t]').forEach((c, i) => c.checked = !!(log.train && log.train[i]));
    document.querySelectorAll('[data-s]').forEach((c, i) => c.checked = !!(log.stretch && log.stretch[i]));
  } else {
    weightEl.value = "";
    document.querySelectorAll('input[type=checkbox]').forEach(c => c.checked = false);
  }
  updateWeightStats();
}

// --- 統計計算 ---
function updateWeightStats() {
  const currentStr = dateEl.value;
  if(!currentStr) return;

  // 入力された日付(YYYY-MM-DD)を分解してローカル日付として扱う
  const [y, m, d] = currentStr.split('-').map(Number);
  
  // 1. 前日の体重
  const yesterday = new Date(y, m - 1, d - 1);
  const yKey = 'log-' + getLocalDateString(yesterday);
  const yLog = JSON.parse(localStorage.getItem(yKey));
  document.getElementById('yWeightDisplay').textContent = (yLog && yLog.weight) ? yLog.weight : '-';

  // 2. 7日間平均 (選択日を含む過去7日)
  let sum = 0;
  let count = 0;

  for (let i = 0; i < 7; i++) {
    const targetDate = new Date(y, m - 1, d - i);
    const dateKey = 'log-' + getLocalDateString(targetDate);
    
    let weightVal = null;

    // 選択中の日付(i=0)かつ、画面上の入力欄に数値がある場合は優先的にそれを使う
    if (i === 0 && weightEl.value !== "") {
      weightVal = parseFloat(weightEl.value);
    } else {
      const log = JSON.parse(localStorage.getItem(dateKey));
      if (log && log.weight) {
        weightVal = parseFloat(log.weight);
      }
    }

    if (weightVal && !isNaN(weightVal)) {
      sum += weightVal;
      count++;
    }
  }

  const avgDisplay = document.getElementById('avgWeightDisplay');
  avgDisplay.textContent = count > 0 ? (sum / count).toFixed(1) : '-';
}

// --- 保存処理 ---
function save() {
  if (!dateEl.value) return;
  const data = {
    weight: weightEl.value,
    train: [...document.querySelectorAll('[data-t]')].map(c => c.checked),
    stretch: [...document.querySelectorAll('[data-s]')].map(c => c.checked)
  };
  localStorage.setItem('log-' + dateEl.value, JSON.stringify(data));
  
  updateWeightStats();
  
  const toast = document.getElementById('toast');
  toast.style.display = 'block';
  setTimeout(() => { toast.style.display = 'none'; }, 1000);
}

// --- 履歴管理 ---
function showHistory() {
  const list = document.getElementById('historyList');
  const keys = Object.keys(localStorage).filter(k => k.startsWith('log-')).sort().reverse();
  
  if (keys.length === 0) {
    list.innerHTML = '<p style="text-align:center;padding:20px;">記録がありません</p>';
  } else {
    list.innerHTML = keys.map(k => {
      const datePart = k.replace('log-', '');
      const log = JSON.parse(localStorage.getItem(k));
      return `<div class="item" style="margin-bottom:8px;height:44px;" onclick="selectHistory('${datePart}')">
                <span>${datePart}</span>
                <span style="margin-left:auto">${log.weight ? log.weight + 'kg' : '-'}</span>
              </div>`;
    }).join('');
  }
  document.getElementById('historyModal').classList.add('show');
}
function closeHistory() { document.getElementById('historyModal').classList.remove('show'); }
function selectHistory(d) {
  dateEl.value = d;
  loadDayData();
  closeHistory();
}

// --- メニュー編集 ---
function openEdit() {
  const modal = document.getElementById('editModal');
  const editTrain = document.getElementById('editTrainList');
  const editStretch = document.getElementById('editStretchList');
  
  modal.classList.add('show');
  editTrain.innerHTML = trainMenu.map((t, i) =>
    `<div class="edit-row">
      <input value="${t.name}" onchange="trainMenu[${i}].name=this.value">
      <input value="${t.count}" style="width:70px" onchange="trainMenu[${i}].count=this.value">
      <button onclick="removeTrain(${i})">×</button>
    </div>`).join('');
    
  editStretch.innerHTML = stretchMenu.map((s, i) =>
    `<div class="edit-row">
      <input value="${s}" onchange="stretchMenu[${i}]=this.value">
      <button onclick="removeStretch(${i})">×</button>
    </div>`).join('');
}
function closeEdit() {
  localStorage.setItem('trainMenu', JSON.stringify(trainMenu));
  localStorage.setItem('stretchMenu', JSON.stringify(stretchMenu));
  document.getElementById('editModal').classList.remove('show');
  renderLists();
  loadDayData();
}
function addTrainItem() { trainMenu.push({name:'新規',count:'10'}); openEdit(); }
function addStretchItem() { stretchMenu.push('新規'); openEdit(); }
function removeTrain(i) { trainMenu.splice(i, 1); openEdit(); }
function removeStretch(i) { stretchMenu.splice(i, 1); openEdit(); }

// --- 初期化 ---
window.onload = () => {
  renderLists();
  loadDayData();
};
</script>
</body>
</html>
