<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Workout Log</title>
  <style>
    :root{
      --gap:8px; --radius:14px;
      --font-lg:22px; --font-md:18px; --font-sm:15px; --font-xs:14px;
      --cell-h:40px; --cell-h-train:55px;
      --bg:#0f172a; --panel:#020617; --cell:#111827;
      --accent:#22c55e;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,"Noto Sans JP";background:var(--bg);color:#e5e7eb;height:100vh;overflow:hidden}
    .app{display:flex;flex-direction:column;height:100%;padding:10px;gap:10px}

    header{display:flex;justify-content:space-between;align-items:center}
    header input{font-size:var(--font-lg);background:var(--panel);color:#e5e7eb;border:none;border-radius:10px;padding:6px 10px}
    .menu-btn{font-size:var(--font-md);padding:10px 14px;border-radius:12px;border:none;background:#1e293b;color:#e5e7eb}

    .weight-wrap{display:grid;grid-template-columns:1fr 2fr;gap:8px}
    .weight-stats{background:var(--panel);border-radius:var(--radius);padding:8px;font-size:18px;display:flex;flex-direction:column;justify-content:center;gap:6px}
    .weight-main{background:var(--panel);border-radius:var(--radius);padding:10px;font-size:26px;font-weight:800;text-align:center;display:flex;flex-direction:column;gap:4px}
    .weight-main input{font-size:26px;width:80px;text-align:center}

    section{background:var(--panel);border-radius:var(--radius);padding:10px}
    section h2{margin:0 0 6px;font-size:var(--font-md)}

    .grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:var(--gap)}
    .item{height:var(--cell-h);background:var(--cell);border-radius:12px;display:flex;align-items:center;padding:0 10px;font-size:var(--font-sm)}
    .item label{display:flex;align-items:center;gap:8px}
    .item input[type=checkbox]{width:20px;height:20px}
    .count{margin-left:auto;font-weight:700}

    .train .item{height:var(--cell-h-train)}

    .action-buttons{display:flex;gap:12px;margin-top:6px}
    .action-buttons button{flex:1;height:50px;font-size:var(--font-md);font-weight:700;border-radius:14px;border:none}
    .save{background:var(--accent);color:#052e16}
    .history{background:#1e293b;color:#e5e7eb}

    /* modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none}
    .modal.show{display:block}
    .sheet{position:absolute;bottom:0;left:0;right:0;background:var(--panel);border-radius:20px 20px 0 0;padding:14px;max-height:80%;overflow:auto}
    .sheet h3{margin:10px 0}
    .edit-row{display:flex;gap:6px;margin-bottom:6px}
    .edit-row input{flex:1;font-size:16px}
    .edit-row button{font-size:16px}

    /* toast */
    #toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);opacity:0;transition:opacity 0.3s;}
    #toast.show{opacity:1}
  </style>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a">
</head>
<body>
<div class="app">
  <header>
    <input type="date" id="date" />
    <button class="menu-btn" onclick="openEdit()">メニュー編集</button>
  </header>

  <div class="weight-wrap">
    <div class="weight-stats">
      <div>前日: <span id="yWeight">-</span> kg</div>
      <div>7日平均: <span id="avgWeight">-</span> kg</div>
    </div>
    <div class="weight-main">
      体重 <input type="number" step="0.1" id="weight" value="63" /> kg <span id="weightUnit">kg</span>
      <div class="action-buttons">
        <button class="save" onclick="save()">保存</button>
        <button class="history" onclick="showHistory()">履歴</button>
      </div>
    </div>
  </div>

  <section>
    <h2>ストレッチ</h2>
    <div class="grid2" id="stretchList"></div>
  </section>

  <section class="train">
    <h2>トレーニング</h2>
    <div class="grid2" id="trainList"></div>
  </section>
</div>

<div id="toast">保存しました</div>

<!-- 履歴一覧 -->
<div class="modal" id="historyModal">
  <div class="sheet">
    <h3>履歴一覧</h3>
    <div id="historyList"></div>
    <button onclick="closeHistory()">閉じる</button>
  </div>
</div>

<!-- メニュー編集 -->
<div class="modal" id="modal">
  <div class="sheet">
    <h3>トレーニング</h3>
    <div id="editTrain"></div>
    <button onclick="addTrain()">＋追加</button>

    <h3>ストレッチ</h3>
    <div id="editStretch"></div>
    <button onclick="addStretch()">＋追加</button>

    <button onclick="closeEdit()">閉じる</button>
  </div>
</div>

<script>
const defaultTrain=[{name:'腕立て',count:'20'},{name:'スクワット',count:'20'}];
const defaultStretch=['頭','首','肩','背中','腰','足'];

let train=JSON.parse(localStorage.getItem('train'))||defaultTrain;
let stretch=JSON.parse(localStorage.getItem('stretch'))||defaultStretch;

const today=new Date().toISOString().slice(0,10);
date.value=today;

function render(){
  trainList.innerHTML=train.map((t,i)=>
    `<div class="item"><label><input type=checkbox data-t="${i}"> ${t.name}</label><span class=count>${t.count}</span></div>`).join('');
  stretchList.innerHTML=stretch.map((s,i)=>
    `<div class="item"><label><input type=checkbox data-s="${i}"> ${s}</label></div>`).join('');
  updateWeightStats();
}

function openEdit(){
  modal.classList.add('show');
  editTrain.innerHTML=train.map((t,i)=>
    `<div class=edit-row><input value="${t.name}" onchange="train[${i}].name=this.value"><input value="${t.count}" style="width:60px" onchange="train[${i}].count=this.value"><button onclick="delTrain(${i})">×</button></div>`).join('');
  editStretch.innerHTML=stretch.map((s,i)=>
    `<div class=edit-row><input value="${s}" onchange="stretch[${i}]=this.value"><button onclick="delStretch(${i})">×</button></div>`).join('');
}
function closeEdit(){modal.classList.remove('show');saveMenus();render();}
function addTrain(){train.push({name:'新規',count:'10'});openEdit()}
function addStretch(){stretch.push('新規');openEdit()}
function delTrain(i){train.splice(i,1);openEdit()}
function delStretch(i){stretch.splice(i,1);openEdit()}
function saveMenus(){
  localStorage.setItem('train',JSON.stringify(train));
  localStorage.setItem('stretch',JSON.stringify(stretch));
}

function save(){
  const data={
    weight:weight.value,
    train:[...document.querySelectorAll('[data-t]')].map(c=>c.checked),
    stretch:[...document.querySelectorAll('[data-s]')].map(c=>c.checked)
  };
  localStorage.setItem('log-'+date.value,JSON.stringify(data));
  showSavedToast();
}

function showSavedToast(){
  const toast=document.getElementById('toast');
  toast.classList.add('show');
  setTimeout(()=>{toast.classList.remove('show');},800);
}

function showHistory(){
  const list=document.getElementById('historyList');
  const keys=Object.keys(localStorage).filter(k=>k.startsWith('log-')).sort().reverse();
  if(keys.length===0){list.innerHTML='<p>履歴がありません</p>'}else{
    list.innerHTML=keys.map(k=>{const d=k.replace('log-','');const log=JSON.parse(localStorage.getItem(k));return `<div class="item" onclick="loadHistory('${d}')">${d} / ${log.weight}kg</div>`}).join('');
  }
  document.getElementById('historyModal').classList.add('show');
}
function closeHistory(){document.getElementById('historyModal').classList.remove('show');}
function loadHistory(d){
  date.value=d;
  const log=JSON.parse(localStorage.getItem('log-'+d));
  if(!log) return;
  weight.value=log.weight;
  weightUnit.textContent='kg';
  document.querySelectorAll('[data-t]').forEach((c,i)=>c.checked=!!log.train[i]);
  document.querySelectorAll('[data-s]').forEach((c,i)=>c.checked=!!log.stretch[i]);
  updateWeightStats();
  closeHistory();
}

function updateWeightStats(){
  const d=new Date(date.value);
  const y=new Date(d); y.setDate(d.getDate()-1);
  const yKey='log-'+y.toISOString().slice(0,10);
  const yLog=JSON.parse(localStorage.getItem(yKey));
  yWeight.textContent=yLog?yLog.weight:'-';
  let sum=0,count=0;
  for(let i=1;i<=7;i++){const t=new Date(d); t.setDate(d.getDate()-i); const log=JSON.parse(localStorage.getItem('log-'+t.toISOString().slice(0,10))); if(log){sum+=Number(log.weight);count++;}}
  avgWeight.textContent=count?(sum/count).toFixed(1):'-';
}

render();
</script>
<script>
if('serviceWorker' in navigator){navigator.serviceWorker.register('./sw.js');}
</script>
</body>
</html>
